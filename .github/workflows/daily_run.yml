import os
import requests
import datetime
from ma_strategy import run_ma_strategy_for_date

# --- ì„¤ì • ---
TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID')

# í‹°ì»¤ ëª…ì¹­ ë§¤í•‘ (ë³´ê³ ì„œ ê°€ë…ì„± í–¥ìƒ)
TICKER_NAMES = {
    '102110.KS': 'TIGER 200', '283580.KS': 'KODEX ì°¨ì´ë‚˜CSI300', 
    '453810.KS': 'KODEX ì¸ë„Nifty50', '148070.KS': 'KIWOOM êµ­ê³ ì±„ 10ë…„', 
    '385560.KS': 'RISE êµ­ê³ ì±„ 30ë…„ Enhanced', 'Cash': 'í˜„ê¸ˆ (ë¯¸íˆ¬ì)'
}

def send_telegram_message(message):
    """í…”ë ˆê·¸ë¨ ë´‡ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜"""
    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        print("ê²½ê³ : TELEGRAM_TOKEN ë˜ëŠ” TELEGRAM_CHAT_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
        print(f"\n[ë³´ê³ ì„œ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°]\n{message}")
        return

    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': message,
        'parse_mode': 'Markdown'
    }
    try:
        response = requests.post(url, data=payload, timeout=10)
        response.raise_for_status()
        print("í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!")
    except requests.exceptions.RequestException as e:
        print(f"í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: {e}")

def get_target_date():
    """
    í˜„ì¬ ìš”ì¼ì„ í™•ì¸í•˜ê³ , ë°ì´í„° ë¶„ì„ ê¸°ì¤€ ë‚ ì§œë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
    (í† ìš”ì¼, ì¼ìš”ì¼, ì›”ìš”ì¼ 8ì‹œ ë°œì†¡ ì‹œ ê¸ˆìš”ì¼ ì¢…ê°€ ê¸°ì¤€)
    """
    today = datetime.date.today()
    
    if today.weekday() == 0:  # ì›”ìš”ì¼ (weekday()ëŠ” ì›”ìš”ì¼ì´ 0)
        # ì›”ìš”ì¼ì€ ì§€ë‚œ ê¸ˆìš”ì¼ ì¢…ê°€ ê¸°ì¤€ (ê¸ˆìš”ì¼ì€ 4)
        return today - datetime.timedelta(days=3)
    elif today.weekday() in [5, 6]:  # í† ìš”ì¼(5), ì¼ìš”ì¼(6) - ë°œì†¡í•˜ì§€ ì•ŠìŒ
        return None
    else:  # í™”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ (ì–´ì œ ì¢…ê°€ ê¸°ì¤€)
        return today - datetime.timedelta(days=1)

def format_report(target_date, weights, daily_return_info):
    """ë³´ê³ ì„œ ë©”ì‹œì§€ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤."""
    
    # ë¹„ì¤‘ì„ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
    sorted_weights = sorted(weights.items(), key=lambda item: item[1], reverse=True)
    
    report_lines = [
        f"ğŸŒŸ **MA ê°œë³„ ì „ëµ ì¼ì¼ ë³´ê³ ì„œ ({target_date.strftime('%Yë…„ %mì›” %dì¼ ê¸°ì¤€')})**",
        "---------------------------------------------------",
        "âœ… **ì „ëµ ê°œìš”:** 5ê°œ ìì‚° (ì£¼ì‹ 3ì¢… + ì±„ê¶Œ 2ì¢…)ì— 20ì¼/120ì¼/200ì¼ MA ì¶”ì„¸ ì‹ í˜¸ ê¸°ë°˜ìœ¼ë¡œ ê°œë³„ ë¹„ì¤‘ ì¡°ì ˆ (í˜„ê¸ˆí™” í¬í•¨)",
        f"ğŸ“… **{daily_return_info}**",
        "",
        "### ğŸ’° ì˜¤ëŠ˜ í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ (Max 100%)",
        "| ìì‚°ëª… | íˆ¬ì ë¹„ì¤‘ |",
        "| :--- | :--- |"
    ]
    
    for ticker, weight in sorted_weights:
        name = TICKER_NAMES.get(ticker, ticker)
        report_lines.append(f"| {name} | **{weight:.2%}** |")
        
    report_lines.append("---------------------------------------------------")
    report_lines.append("âš ï¸ **ì°¸ê³ :** MDD -3.34%, CAGR 16.31% (2024ë…„ 3ì›”~2025ë…„ 11ì›” ë°±í…ŒìŠ¤íŠ¸ ê¸°ì¤€)")
    
    return "\n".join(report_lines)

if __name__ == "__main__":
    
    target_date = get_target_date()
    
    if target_date is None:
        print("ì˜¤ëŠ˜ì€ ì£¼ë§(í† /ì¼)ì´ë¯€ë¡œ ë³´ê³ ì„œë¥¼ ë°œì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    else:
        print(f"ë¶„ì„ ê¸°ì¤€ ë‚ ì§œ: {target_date.strftime('%Y-%m-%d')}")
        
        # 1. MA ì „ëµ ì‹¤í–‰ ë° ìµœì¢… ë¹„ì¤‘ ê³„ì‚°
        weights, daily_return_info = run_ma_strategy_for_date(target_date)
        
        if weights is None:
            report = f"âŒ **MA ê°œë³„ ì „ëµ ë³´ê³ ì„œ - ì‹¤íŒ¨**\në¶„ì„ ê¸°ì¤€ì¼: {target_date.strftime('%Y-%m-%d')}\nì‚¬ìœ : {daily_return_info}"
        else:
            # 2. ë³´ê³ ì„œ í¬ë§·íŒ…
            report = format_report(target_date, weights, daily_return_info)
        
        # 3. í…”ë ˆê·¸ë¨ ì „ì†¡
        send_telegram_message(report)
