name: Daily MA Strategy Report

on:
  schedule:
    # ë§¤ì¼ 23:00 UTCì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„ KST = UTC + 9, ì¦‰ ì˜¤ì „ 8ì‹œ)
    - cron: '0 23 * * *'
    
  workflow_dispatch: # Actions íƒ­ì— ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ì„ í‘œì‹œí•˜ëŠ” íŠ¸ë¦¬ê±°
    inputs:
      test_mode:
        description: 'Enable Test Mode (Bypasses weekend check, runs on latest data).'
        required: true
        default: 'FALSE'
        type: choice
        options:
        - 'TRUE'
        - 'FALSE'

jobs:
  run_daily_strategy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3

    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v3
      with:
        python-version: '3.x'

    - name: âš™ï¸ ì¢…ì†ì„± ì„¤ì¹˜ (requirements.txt)
      # Pip ê²½ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ upgradeì™€ installì„ ëª…ì‹œì ìœ¼ë¡œ ì‹¤í–‰
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # --- 1. MA ì „ëµ ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜ (ìµœì¢… ì˜¤ë¥˜ ë°©ì§€ ë¡œì§) ---
    - name: ğŸš€ MA ì „ëµ ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜
      id: strategy_output
      env:
        # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì— í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        # Python ì‹¤í–‰ ê²½ë¡œì— ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í¬í•¨ë˜ë„ë¡ PATH ì„¤ì •
        export PYTHONPATH=$(python -c "import site; print(site.getusersitepackages()[0])"):$PYTHONPATH
        
        # ğŸš¨ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜
        # stderr(ì˜¤ë¥˜)ë¥¼ stdoutìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ì—¬ ìº¡ì²˜í•©ë‹ˆë‹¤.
        REPORT_CONTENT=$(python daily_signal_generator.py 2>&1)
        
        # GITHUB_OUTPUTì— ìº¡ì²˜ëœ ë‚´ìš© í• ë‹¹
        echo "report<<EOF" >> $GITHUB_OUTPUT
        echo "$REPORT_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # --- 2. í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ---
    - name: ğŸ“© í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }} 
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: ${{ steps.strategy_output.outputs.report }}
        format: markdown 
      if: always()
